<script>

// ================= MAPA =================

const huertosFamiliares = [-36.8404, -73.1036];
const map = L.map('map').setView(huertosFamiliares, 15);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const drawControl = new L.Control.Draw({
    draw:{
        polygon:true,
        rectangle:false,
        circle:false,
        marker:false,
        polyline:false,
        circlemarker:false
    },
    edit:{ featureGroup: drawnItems }
});
map.addControl(drawControl);

let zones = {
    1500:null,
    2500:null
};

let currentMarker = null;

// ================= ZONAS PREDETERMINADAS =================

const defaultZone1500 = { /* TU JSON ORIGINAL SIN CAMBIOS */ };
const defaultZone2500 = { /* TU JSON ORIGINAL SIN CAMBIOS */ };

// ⚠️ IMPORTANTE:
// Mantén exactamente los mismos JSON que ya tienes.
// No los repito aquí para no alterar nada accidentalmente.

loadZones();

function loadZones(){

    let layer1500 = L.geoJSON(defaultZone1500,{
        style:{ color:"green" }
    }).getLayers()[0];

    zones[1500] = layer1500;
    drawnItems.addLayer(layer1500);

    let layer2500 = L.geoJSON(defaultZone2500,{
        style:{ color:"red" }
    }).getLayers()[0];

    zones[2500] = layer2500;
    drawnItems.addLayer(layer2500);
}

// ================= DIBUJAR NUEVAS ZONAS =================

map.on(L.Draw.Event.CREATED, function(e){

    const price = document.getElementById("zoneSelector").value;
    const layer = e.layer;

    layer.setStyle({
        color: price == 1500 ? "green" : "red"
    });

    if(zones[price]){
        drawnItems.removeLayer(zones[price]);
    }

    zones[price] = layer;
    drawnItems.addLayer(layer);
});

// ================= NORMALIZACIÓN =================

function normalizeAddress(text){
    return text
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/\bav\b/g,"avenida")
        .replace(/\bpto\b/g,"puerto")
        .replace(/\bpje\b/g,"pasaje")
        .trim();
}

// ================= BUSCAR DIRECCIÓN (V2 PROFESIONAL) =================

async function searchAddress(){

    const rawAddress = document.getElementById("addressInput").value;
    if(!rawAddress){
        alert("Ingresa una dirección");
        return;
    }

    const address = normalizeAddress(rawAddress);

    const viewbox = "-73.15,-36.88,-73.05,-36.80";

    const url = `https://nominatim.openstreetmap.org/search?format=json&street=${encodeURIComponent(address)}&city=San Pedro de la Paz&country=Chile&countrycodes=cl&addressdetails=1&limit=3&viewbox=${viewbox}&bounded=1`;

    try{

        const response = await fetch(url,{
            headers:{ "Accept-Language":"es" }
        });

        const data = await response.json();

        if(data.length === 0){
            alert("Dirección no encontrada");
            return;
        }

        // Buscar resultado con número real si existe
        let result = data.find(item => item.address && item.address.house_number);

        if(!result){
            result = data[0]; // fallback al primero
        }

        const lat = parseFloat(result.lat);
        const lon = parseFloat(result.lon);

        if(currentMarker){
            map.removeLayer(currentMarker);
        }

        currentMarker = L.marker([lat,lon]).addTo(map);

        map.setView([lat,lon],18);

        checkZones(lat,lon);
        saveToHistory(rawAddress);

    }catch(error){
        console.error("Error en búsqueda:", error);
        alert("Error al buscar la dirección");
    }
}

// ================= VERIFICAR ZONA =================

function isInside(point, vs){
    let x = point[0], y = point[1];
    let inside = false;
    for(let i=0, j=vs.length-1; i<vs.length; j=i++){
        let xi=vs[i][0], yi=vs[i][1];
        let xj=vs[j][0], yj=vs[j][1];
        let intersect=((yi>y)!=(yj>y)) &&
            (x<(xj-xi)*(y-yi)/(yj-yi)+xi);
        if(intersect) inside=!inside;
    }
    return inside;
}

function checkZones(lat,lon){

    const resultDiv = document.getElementById("result");

    for(let price of [1500,2500]){
        if(zones[price]){
            const coords = zones[price].getLatLngs()[0].map(c=>[c.lat,c.lng]);
            if(isInside([lat,lon],coords)){
                resultDiv.innerHTML = `DENTRO DEL REPARTO<br>Precio: $${price}`;
                resultDiv.className = "inside";
                return;
            }
        }
    }

    resultDiv.innerHTML = "FUERA DEL REPARTO";
    resultDiv.className = "outside";
}

// ================= HISTORIAL =================

function saveToHistory(address){
    let history = JSON.parse(localStorage.getItem("searchHistory")) || [];
    history.unshift(address);
    history = history.slice(0,10);
    localStorage.setItem("searchHistory", JSON.stringify(history));
    renderHistory();
}

function renderHistory(){
    const historyList = document.getElementById("historyList");
    historyList.innerHTML = "";
    let history = JSON.parse(localStorage.getItem("searchHistory")) || [];

    history.forEach(item=>{
        const div = document.createElement("div");
        div.className="history-item";
        div.textContent=item;
        div.onclick=()=>{
            document.getElementById("addressInput").value=item;
            searchAddress();
        };
        historyList.appendChild(div);
    });
}

renderHistory();

</script>
